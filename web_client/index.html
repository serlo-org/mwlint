<!DOCTYPE html>

<html> 
    <head>
        <meta charset="UTF-8">
        <link rel="stylesheet" type="text/css" href="codemirror.css">
        <link rel="stylesheet" type="text/css" href="linter.css">
        <link rel="stylesheet" type="text/css" href="lint.css">
        <script src="codemirror.js"></script>
        <script src="markdown.js"></script>
        <script src="active-line.js"></script>
        <script src="matchbrackets.js"></script>
        <script src="lint.js"></script>
        <script src="mw-lint.js"></script>

        <script type="text/javascript">
            var base = "http://localhost:8000/";
            var last_lints = [];

            function escapeHtml(unsafe) {
                return unsafe
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }

            function build_parse_lint(err) {
                var expected = escapeHtml(err.expected.join(", "));
                return {
                    position: {
                        start: {
                            line: err.position.line,
                            col: err.position.col,
                        },
                        end: {
                            line: err.position.line,
                            col: err.position.col,
                        }
                    },
                    severity: "error",
                    explanation_long: "A syntax error occurs when there are mistakes in your code which make it impossible for analyse you document. These are often missing closing brackets and the likes. Also check the surrounding code, as the mistake might have happend before or after the given position.",
                    explanation: "Syntax error!",
                    solution: "Expected one of: " + expected,
                };
            }

            function build_transformation_lint(err) {
                return {
                    severity: "error",
                    explanation_long: "A transformation error occurs when a document could not be properly processed after parsing. This can occur if you have a peculiar heading or list structure.",
                    explanation: err.cause,
                    position: err.position,
                    solution: "somehow this document does not conform with the usual document structure...",
                };
            }

            function fetch_lints(source) {
                var xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function() {
                    if (this.readyState == 4 && this.status == 200) {
                        var result = JSON.parse(this.responseText);
                        // errors
                        if (result.hasOwnProperty("Error")) {

                            // parse error
                            if (result.Error.hasOwnProperty("parseerror")) {
                                var lint = build_parse_lint(result.Error.parseerror);
                                last_lints = [lint]; 
                            }

                            // transformation errors
                            if (result.Error.hasOwnProperty("transformationerror")) {
                                var lint = build_transformation_lint(
                                    result.Error.transformationerror
                                );
                                last_lints = [lint]
                            }
                        }
                        
                        // lints
                        if (result.hasOwnProperty("Lints")) {
                            last_lints = result.Lints;
                        }
                    }
                };
                xhttp.open("POST", base, true);
                xhttp.setRequestHeader("Content-type","application/x-www-form-urlencoded");
                xhttp.send("source=" + encodeURIComponent(source)); 
            }

            function submit_source() {
                var source = editor.getValue("\n") + "\n";
                fetch_lints(source);
            };
            
            
        </script>
        <title>MFNF-Linter</title> 
    </head>
    <body>
        <h1>Submit to linter</h1>
        <button onclick="submit_source()">Force Lints</button>
        <div id="content_div">
            <textarea id="source_input"></textarea> 
        </div>
        <div id="results">Bla..!</div>
        <script>
            var editor = CodeMirror.fromTextArea(document.getElementById("source_input"), {
                lineNumbers: true,
                styleActiveLine: true,
                matchBrackets: true,
                gutters: ["CodeMirror-lint-markers"],
                lint: true,
                mode: {name: "markdown"},
                viewportMargin: Infinity,
            });
            editor.on("changes", submit_source);
        </script>
    </body>
</html>
